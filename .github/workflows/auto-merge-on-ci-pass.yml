name: Smart Governance Gate

# Risk-based merge policy: "AI writes code, AI does not ship code"
# Low-risk (docs/config only) -> auto-merge after CI
# High-risk (outreach engine, live jobs, lead data) -> human approval required

on:
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  governance-gate:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' ||
      github.event.check_suite.conclusion == 'success'
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const head_sha = context.payload.workflow_run?.head_sha ||
                            context.payload.check_suite?.head_sha;
            if (!head_sha) {
              core.setOutput('found', 'false');
              return;
            }

            const { data: prsByCommit } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: head_sha
            });

            const openPrs = prsByCommit.filter(pr => pr.state === 'open');
            if (openPrs.length > 0) {
              console.log(`Found PR #${openPrs[0].number}`);
              core.setOutput('number', openPrs[0].number);
              core.setOutput('found', 'true');
            } else {
              core.setOutput('found', 'false');
            }

      - name: Classify risk and check governance
        id: classify
        if: steps.pr.outputs.found == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const pr_number = ${{ steps.pr.outputs.number || 0 }};
            if (!pr_number) return;

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            const filePaths = files.map(f => f.filename);
            console.log(`Changed files: ${filePaths.join(', ')}`);

            // High-risk: outreach engine, live jobs, lead data, SMS/call, CI
            const highRiskPatterns = [
              /^autonomy\/tools\//,
              /^autonomy\/engine\.py/,
              /^autonomy\/run\.py/,
              /^autonomy\/outreach_policy\.py/,
              /^autonomy\/providers\.py/,
              /^autonomy\/state\//,
              /^autonomy\/data\//,
              /^\.github\/workflows\//,
              /\.env/,
              /config\..*\.live\.json/
            ];

            const isHighRisk = filePaths.some(fp =>
              highRiskPatterns.some(pattern => pattern.test(fp))
            );

            // Check required CI checks
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            const requiredChecks = ['Python Quality', 'Security', 'Smoke Test'];
            let allRequiredPassed = true;

            for (const check of requiredChecks) {
              const run = checkRuns.check_runs.find(r => r.name === check);
              if (!run || run.status !== 'completed' || run.conclusion !== 'success') {
                allRequiredPassed = false;
                console.log(`Required check '${check}' not passing`);
              }
            }

            const riskLevel = isHighRisk ? 'high' : 'low';
            console.log(`Risk: ${riskLevel}, Checks passed: ${allRequiredPassed}`);

            core.setOutput('risk', riskLevel);
            core.setOutput('checks_passed', allRequiredPassed ? 'true' : 'false');
            core.setOutput('file_list', filePaths.join('\n'));

      # LOW RISK + checks pass -> auto-merge
      - name: Auto-merge (low risk)
        if: >
          steps.pr.outputs.found == 'true' &&
          steps.classify.outputs.risk == 'low' &&
          steps.classify.outputs.checks_passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Low-risk PR with all checks passing - auto-merging"
          gh pr merge ${{ steps.pr.outputs.number }} \
            --repo ${{ github.repository }} \
            --squash \
            --delete-branch \
            --body "Auto-merged: low-risk change, all CI checks passed"

      # HIGH RISK -> label for human review
      - name: Request human review (high risk)
        if: >
          steps.pr.outputs.found == 'true' &&
          steps.classify.outputs.risk == 'high' &&
          steps.classify.outputs.checks_passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR=${{ steps.pr.outputs.number }}
          gh pr edit "$PR" --repo ${{ github.repository }} --add-label "needs-ceo-review"
          gh pr comment "$PR" --repo ${{ github.repository }} \
            --body "**Governance Gate: Human Review Required**

          This PR touches high-risk files (outreach engine, live jobs, CI, or lead data).

          Policy: AI writes code, AI does not ship code.

          All CI checks passed. Awaiting CEO approval to merge."

      # CHECKS FAILED -> block
      - name: Block merge (checks failed)
        if: >
          steps.pr.outputs.found == 'true' &&
          steps.classify.outputs.checks_passed == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ steps.pr.outputs.number }} \
            --repo ${{ github.repository }} \
            --body "**Governance Gate: Blocked** - Required CI checks have not passed."
