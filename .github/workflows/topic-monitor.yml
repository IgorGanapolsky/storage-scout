name: Topic Monitor

# 24/7 Topic Monitoring with AI-Powered Importance Scoring
# Monitors markets, competitors, and mentions relevant to business

on:
  schedule:
    # Every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      topic:
        description: 'Specific topic to monitor (or "all")'
        required: false
        default: 'all'

jobs:
  monitor-topics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Monitor Topics
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          TOPIC_FILTER: ${{ github.event.inputs.topic || 'all' }}
        run: |
          echo "Topic Monitor - $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""

          # Topics to monitor
          declare -A TOPICS
          TOPICS["storage-arbitrage"]="storage arbitrage OR neighbor.com OR self-storage spread"
          TOPICS["tool-rental"]="tool rental business OR power tool rental OR 2quip"
          TOPICS["gumroad-automation"]="github actions automation gumroad OR free tier workflow"
          TOPICS["competitor-watch"]="zapier alternative OR n8n self-hosted OR github actions cron"

          # Function to send alert
          send_alert() {
            local title="$1"
            local message="$2"
            local priority="${3:-default}"

            curl -s -d "$message" \
              -H "Title: $title" \
              -H "Priority: $priority" \
              -H "Tags: eye,bell" \
              "https://ntfy.sh/$NTFY_TOPIC" || true
          }

          # Check each topic
          for topic in "${!TOPICS[@]}"; do
            if [ "$TOPIC_FILTER" != "all" ] && [ "$TOPIC_FILTER" != "$topic" ]; then
              continue
            fi

            echo "Checking: $topic"
            echo "  Query: ${TOPICS[$topic]}"

            # Placeholder for actual search implementation
            # In production, this would call search APIs
            echo "  Status: Monitored at $(date)"
            echo ""
          done

          # Send daily digest notification
          if [ "$(date +%H)" = "08" ]; then
            send_alert "ðŸ“Š Daily Topic Digest" \
              "Topics monitored: ${#TOPICS[@]}\n\nTopics: storage-arbitrage, tool-rental, gumroad-automation, competitor-watch\n\nAll clear - no high-priority alerts." \
              "low"
          fi

          echo "Monitor complete."

      - name: Update state
        run: |
          mkdir -p data/topic_monitor
          echo "{\"last_run\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"topics_checked\": 4}" > data/topic_monitor/state.json

      - name: Commit state
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/topic_monitor/ || true
          git diff --staged --quiet || git commit -m "chore: topic monitor $(date +%Y%m%d-%H%M)"
          git push || echo "No changes to push"

  monitor-hn-post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check HN Post Status
        env:
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        run: |
          POST_ID="46865237"
          API_URL="https://hacker-news.firebaseio.com/v0/item/${POST_ID}.json"

          echo "Checking HN post: $POST_ID"

          DATA=$(curl -s "$API_URL" 2>/dev/null || echo "{}")

          if [ -z "$DATA" ] || [ "$DATA" = "null" ] || [ "$DATA" = "{}" ]; then
            echo "Failed to fetch HN data"
            exit 0
          fi

          SCORE=$(echo "$DATA" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('score', 0))" 2>/dev/null || echo "0")
          COMMENTS=$(echo "$DATA" | python3 -c "import sys,json; d=json.load(sys.stdin); print(len(d.get('kids', [])))" 2>/dev/null || echo "0")

          echo "Score: $SCORE"
          echo "Comments: $COMMENTS"

          # Alert on milestones
          if [ "$SCORE" -ge 50 ]; then
            curl -s -d "ðŸš€ HN POST HIT 50+ POINTS!\n\nScore: $SCORE\nComments: $COMMENTS\n\nhttps://news.ycombinator.com/item?id=$POST_ID" \
              -H "Title: HN Front Page!" \
              -H "Priority: urgent" \
              -H "Tags: rocket,fire" \
              "https://ntfy.sh/$NTFY_TOPIC" || true
          elif [ "$SCORE" -ge 20 ]; then
            curl -s -d "ðŸ”¥ HN POST GAINING TRACTION!\n\nScore: $SCORE\nComments: $COMMENTS\n\nhttps://news.ycombinator.com/item?id=$POST_ID" \
              -H "Title: HN Traction" \
              -H "Priority: high" \
              -H "Tags: fire" \
              "https://ntfy.sh/$NTFY_TOPIC" || true
          fi
