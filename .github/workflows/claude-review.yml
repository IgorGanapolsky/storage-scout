name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]

jobs:
  # Claude deep review for architectural and project-specific checks
  claude-review:
    name: Claude Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this PR for CallCatcher Ops and its automation tooling.

            CRITICAL CHECKS (fail the review if violated):
            1. No hardcoded secrets, API keys, or tokens in source code
            2. No PII committed to the repository
            3. Outreach engine remains safe by default (dry-run unless explicitly configured)
            4. Email sending uses environment variables for credentials

            STYLE CHECKS (suggest improvements):
            - Keep Python code readable and minimal
            - Avoid unnecessary dependencies
            - Document public APIs or scripts

            SECURITY CHECKS:
            - No secrets, API keys, or credentials in code
            - Validate all external inputs
            - Use HTTPS for all network calls

            Output format:
            - Start with overall assessment (APPROVE, REQUEST_CHANGES, or COMMENT)
            - List specific issues with file:line references
            - Provide fix suggestions for each issue
          claude_args: "--max-turns 10 --model claude-sonnet-4-5-20250929"

  # On-demand Claude assist via @claude mention
  claude-assist:
    name: Claude Assist
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Claude Code Assist
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            A reviewer mentioned @claude with the following comment:

            ${{ github.event.comment.body }}

            Context: This repo hosts CallCatcher Ops assets and automation:
            - Marketing site in `docs/callcatcherops/`
            - Outreach engine in `autonomy/`
            - Optional tools rental experiments in `tools_rental/`

            Respond helpfully to their request. If they're asking for code changes,
            explain what needs to be done and where. Be specific with file paths.
          claude_args: "--max-turns 5"

  # Copilot coding agent for auto-fix (triggered by @copilot in comments)
  copilot-autofix:
    name: Copilot Auto-Fix
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@copilot fix')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Notify Copilot triggered
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ¤– Copilot coding agent triggered. Check your repository settings to ensure Copilot coding agent is enabled.\n\nTo use: Assign an issue to `@copilot` or mention `@copilot` in the issue description.'
            });
