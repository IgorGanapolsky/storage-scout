name: Snyk Auto-Remediation

# Ona pattern: resolve CVEs, rerun scan until clean, open PR
# Scheduled Sunday 8pm EST so clean PRs are ready Monday morning

on:
  schedule:
    # Sunday 8:00 PM EST (Monday 01:00 UTC)
    - cron: '0 1 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  remediate:
    name: Fix Vulnerabilities
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r autonomy/tools/requirements.txt 2>/dev/null || true
          npm install -g snyk 2>/dev/null || true

      - name: Check for Snyk token
        id: token
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "available=false" >> $GITHUB_OUTPUT
            echo "SNYK_TOKEN not configured — skipping"
          else
            echo "available=true" >> $GITHUB_OUTPUT
          fi

      - name: Run Snyk and auto-fix
        id: fix
        if: steps.token.outputs.available == 'true'
        run: |
          # Run snyk test, capture vulnerabilities
          snyk test --severity-threshold=high --json > /tmp/snyk-before.json 2>&1 || true

          VULN_COUNT=$(jq '.vulnerabilities | length // 0' /tmp/snyk-before.json 2>/dev/null || echo "0")
          echo "Found $VULN_COUNT high+ severity vulnerabilities"

          if [ "$VULN_COUNT" = "0" ]; then
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            echo "No vulnerabilities to fix"
            exit 0
          fi

          # Auto-fix with snyk wizard or pip-audit
          pip install pip-audit 2>/dev/null || true
          pip-audit --fix --requirement autonomy/tools/requirements.txt 2>/dev/null || true

          # Check if anything changed
          if git diff --quiet; then
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            echo "Snyk found issues but auto-fix couldn't resolve them"
          else
            echo "has_fixes=true" >> $GITHUB_OUTPUT
            echo "vuln_count=$VULN_COUNT" >> $GITHUB_OUTPUT
          fi

      - name: Verify fix
        id: verify
        if: steps.fix.outputs.has_fixes == 'true'
        run: |
          snyk test --severity-threshold=high --json > /tmp/snyk-after.json 2>&1 || true
          REMAINING=$(jq '.vulnerabilities | length // 0' /tmp/snyk-after.json 2>/dev/null || echo "0")
          echo "remaining=$REMAINING" >> $GITHUB_OUTPUT

      - name: Create PR
        if: steps.fix.outputs.has_fixes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="ralph/snyk-autofix-$(date +%Y%m%d)"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "fix(security): auto-remediate ${{ steps.fix.outputs.vuln_count }} Snyk vulnerabilities

          Automated by Ralph Snyk Auto-Remediation workflow.
          Remaining after fix: ${{ steps.verify.outputs.remaining }} vulnerabilities."

          git push -u origin "$BRANCH"

          gh pr create \
            --base develop \
            --title "fix(security): auto-remediate Snyk vulnerabilities" \
            --body "## Automated Security Fix

          **Before**: ${{ steps.fix.outputs.vuln_count }} high+ severity vulnerabilities
          **After**: ${{ steps.verify.outputs.remaining }} remaining

          Auto-generated by Ralph Snyk Auto-Remediation.
          Runs every Sunday 8pm EST — review Monday morning.

          ---
          Policy: AI writes code, AI does not ship code." \
            --label "security,ralph-mode"
