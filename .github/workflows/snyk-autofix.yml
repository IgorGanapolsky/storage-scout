name: Snyk Auto-Remediation

# Resolve CVEs, rerun scan until clean, open PR
# Scheduled Sunday 8pm EST so clean PRs are ready Monday morning

on:
  schedule:
    - cron: '0 1 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  remediate:
    name: Fix Vulnerabilities
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r autonomy/tools/requirements.txt 2>/dev/null || true

      - name: Check for Snyk token
        id: token
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "available=false" >> $GITHUB_OUTPUT
          else
            echo "available=true" >> $GITHUB_OUTPUT
          fi

      - name: Run Snyk and auto-fix
        id: fix
        if: steps.token.outputs.available == 'true'
        run: |
          npm install -g snyk 2>/dev/null || true
          snyk test --severity-threshold=high --json > /tmp/snyk-before.json 2>&1 || true

          VULN_COUNT=$(jq '.vulnerabilities | length // 0' /tmp/snyk-before.json 2>/dev/null || echo "0")
          echo "Found $VULN_COUNT high+ severity vulnerabilities"

          if [ "$VULN_COUNT" = "0" ]; then
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          pip install pip-audit 2>/dev/null || true
          pip-audit --fix --requirement autonomy/tools/requirements.txt 2>/dev/null || true

          if git diff --quiet; then
            echo "has_fixes=false" >> $GITHUB_OUTPUT
          else
            echo "has_fixes=true" >> $GITHUB_OUTPUT
            echo "vuln_count=$VULN_COUNT" >> $GITHUB_OUTPUT
          fi

      - name: Create PR
        if: steps.fix.outputs.has_fixes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="ralph/snyk-autofix-$(date +%Y%m%d)"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "fix(security): auto-remediate ${{ steps.fix.outputs.vuln_count }} Snyk vulnerabilities"
          git push -u origin "$BRANCH"

          gh pr create \
            --base main \
            --title "fix(security): auto-remediate Snyk vulnerabilities" \
            --body "## Automated Security Fix

          **Before**: ${{ steps.fix.outputs.vuln_count }} high+ severity vulnerabilities

          Auto-generated by Ralph Snyk Auto-Remediation.
          Runs every Sunday 8pm EST.

          Policy: AI writes code, AI does not ship code." \
            --label "security,ralph-mode"
