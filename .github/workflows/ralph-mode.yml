name: Ralph Mode - Autonomous Agent Loop

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number
      max_iterations:
        description: 'Max iterations before giving up'
        required: false
        default: '10'
        type: string

jobs:
  # Gate: Only run on issues labeled 'ralph-mode'
  check-label:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.check.outputs.issue_number }}
    steps:
      - name: Check for ralph-mode label
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "issue_number=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          elif [[ "${{ contains(github.event.issue.labels.*.name, 'ralph-mode') }}" == "true" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # Phase 1: Claude Coding Agent - Generate implementation
  code-generation:
    needs: check-label
    if: needs.check-label.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      branch_name: ${{ steps.branch.outputs.name }}
      pr_number: ${{ steps.pr.outputs.number }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Create feature branch
        id: branch
        run: |
          BRANCH="ralph/issue-${{ needs.check-label.outputs.issue_number }}-$(date +%s)"
          git checkout -b $BRANCH
          echo "name=$BRANCH" >> $GITHUB_OUTPUT

      - name: Get issue details
        id: issue
        run: |
          gh issue view ${{ needs.check-label.outputs.issue_number }} --json title,body > issue.json
          echo "title=$(jq -r '.title' issue.json)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Claude Code Generation
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are in RALPH MODE - autonomous coding agent.

            TASK: Implement issue #${{ needs.check-label.outputs.issue_number }}

            Read the issue details and implement the requested changes.

            RULES:
            1. Write working code that passes all tests
            2. Follow existing patterns in the codebase
            3. Add tests for new functionality
            4. Keep changes minimal and focused
            5. DO NOT break existing tests

            After implementation:
            - Run `ruff check tools_rental/ digital_products/ --select E,F,W --ignore E501`
            - Fix any failing checks
            - Commit with clear message referencing the issue

            LOOP until tests pass or you've tried 5 times.
          claude_args: "--max-turns 20 --model claude-sonnet-4-5-20250929"

      - name: Push changes
        run: |
          git push -u origin ${{ steps.branch.outputs.name }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create PR
        id: pr
        run: |
          PR_URL=$(gh pr create \
            --title "Ralph Mode: ${{ steps.issue.outputs.title }}" \
            --body "## Automated Implementation

          Closes #${{ needs.check-label.outputs.issue_number }}

          ---
          ü§ñ Generated by Ralph Mode autonomous agent

          **Review required by superior intelligence before merge.**" \
            --base develop \
            --head ${{ steps.branch.outputs.name }} \
            --label "ralph-mode,needs-review")
          echo "number=$(echo $PR_URL | grep -oE '[0-9]+$')" >> $GITHUB_OUTPUT
          echo "url=$PR_URL" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Phase 2: Test Loop - Run until pass or max iterations
  test-loop:
    needs: [check-label, code-generation]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    strategy:
      max-parallel: 1
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.code-generation.outputs.branch_name }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install ruff
        run: pip install ruff

      - name: Run tests with retry loop
        id: tests
        run: |
          MAX_ITERATIONS=${{ github.event.inputs.max_iterations || '10' }}
          ITERATION=0

          while [ $ITERATION -lt $MAX_ITERATIONS ]; do
            ITERATION=$((ITERATION + 1))
            echo "::group::Iteration $ITERATION of $MAX_ITERATIONS"

            if ruff check tools_rental/ digital_products/ --select E,F,W --ignore E501; then
              echo "‚úÖ Tests passed on iteration $ITERATION"
              echo "status=passed" >> $GITHUB_OUTPUT
              echo "iterations=$ITERATION" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "‚ùå Checks failed, attempting fix..."
            echo "::endgroup::"
          done

          echo "status=failed" >> $GITHUB_OUTPUT
          echo "iterations=$MAX_ITERATIONS" >> $GITHUB_OUTPUT
          exit 1

      - name: Update PR status
        if: always()
        run: |
          if [[ "${{ steps.tests.outputs.status }}" == "passed" ]]; then
            gh pr comment ${{ needs.code-generation.outputs.pr_number }} \
              --body "‚úÖ **Tests passed** after ${{ steps.tests.outputs.iterations }} iteration(s).

          Ready for superior intelligence review."
          else
            gh pr comment ${{ needs.code-generation.outputs.pr_number }} \
              --body "‚ùå **Tests failed** after ${{ steps.tests.outputs.iterations }} iterations.

          Manual intervention required."
            gh pr edit ${{ needs.code-generation.outputs.pr_number }} --add-label "needs-manual-fix"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Phase 3: Superior Intelligence Audit
  superior-audit:
    needs: [code-generation, test-loop]
    if: success()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.code-generation.outputs.branch_name }}

      - name: Claude Superior Intelligence Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are the SUPERIOR INTELLIGENCE auditor in Ralph Mode.

            Your job: Review the AI-generated code with extreme scrutiny.

            AUDIT CHECKLIST:
            ‚ñ° Security: No hardcoded secrets, proper input validation
            ‚ñ° Logic: Business logic is correct (spread formula, thresholds)
            ‚ñ° Quality: Code follows project patterns, is maintainable
            ‚ñ° Tests: Test coverage is adequate, edge cases handled
            ‚ñ° Performance: No obvious performance issues
            ‚ñ° Breaking changes: Existing functionality preserved

            CRITICAL CHECKS for Storage Scout:
            - Spread = (neighborRate * 4) - commercialPrice - insurance
            - Insurance default = $12
            - High priority threshold = $120
            - GitHub token via String.fromEnvironment only

            OUTPUT:
            - APPROVE: If all checks pass
            - REQUEST_CHANGES: If issues found (list them)
            - BLOCK: If security issues or critical bugs found

            Be harsh. Be thorough. Reject anything suspicious.
          claude_args: "--max-turns 10 --model claude-sonnet-4-5-20250929"

  # Phase 4: Auto-merge if approved
  auto-merge:
    needs: [code-generation, superior-audit]
    if: success()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Enable auto-merge
        run: |
          gh pr merge ${{ needs.code-generation.outputs.pr_number }} \
            --auto --squash \
            --subject "Ralph Mode: Auto-merged after superior audit"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify completion
        run: |
          gh pr comment ${{ needs.code-generation.outputs.pr_number }} \
            --body "üéâ **Ralph Mode Complete**

          - Code generated autonomously
          - Tests passed
          - Superior intelligence audit approved
          - Auto-merge enabled

          PR will merge when branch protections pass."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
