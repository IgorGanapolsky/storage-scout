name: Prune Old CSV Entries

on:
  schedule:
    # Run on the 1st of every month at midnight UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  prune:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Prune CSV to last 90 days
        run: |
          FILE="storage_spreads.csv"
          CUTOFF=$(date -d '90 days ago' +%Y-%m-%d)

          if [ ! -f "$FILE" ]; then
            echo "CSV file not found"
            exit 0
          fi

          # Keep header and entries newer than cutoff
          head -1 "$FILE" > temp.csv
          tail -n +2 "$FILE" | while IFS=, read -r timestamp rest; do
            entry_date=$(echo "$timestamp" | cut -d'T' -f1)
            if [[ "$entry_date" > "$CUTOFF" ]] || [[ "$entry_date" == "$CUTOFF" ]]; then
              echo "$timestamp,$rest" >> temp.csv
            fi
          done

          mv temp.csv "$FILE"

          LINES=$(wc -l < "$FILE")
          echo "CSV pruned. Remaining entries: $((LINES - 1))"

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add storage_spreads.csv
          git diff --staged --quiet || git commit -m "Prune CSV entries older than 90 days"
          git push
