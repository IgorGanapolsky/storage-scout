<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storage Spread Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-gray-800">Storage Spread Dashboard</h1>
      <p class="text-gray-600">Coral Springs Market Analysis (33071, 33076)</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-sm font-medium text-gray-500">Total Entries</h3>
        <p id="total-entries" class="text-2xl font-bold text-gray-900">-</p>
      </div>
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-sm font-medium text-gray-500">Avg Monthly Spread</h3>
        <p id="avg-spread" class="text-2xl font-bold text-green-600">-</p>
      </div>
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-sm font-medium text-gray-500">High Priority Deals</h3>
        <p id="high-priority" class="text-2xl font-bold text-blue-600">-</p>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4">Monthly Spread by Facility</h2>
      <canvas id="spreadChart"></canvas>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-4">Recent Entries</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Facility</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Zip</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">10x20 Price</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">5x5 P2P</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Spread</th>
            </tr>
          </thead>
          <tbody id="entries-table" class="bg-white divide-y divide-gray-200">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Configure your GitHub raw CSV URL here
    const CSV_URL = 'https://raw.githubusercontent.com/YOUR_USERNAME/storage/main/storage_spreads.csv';

    async function fetchData() {
      try {
        const response = await fetch(CSV_URL);
        if (!response.ok) throw new Error('CSV not found');
        const text = await response.text();
        return parseCSV(text);
      } catch (e) {
        console.error('Error fetching CSV:', e);
        return [];
      }
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      if (lines.length < 2) return [];

      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const values = line.split(',');
        return {
          timestamp: values[0],
          facility: values[1],
          zip: values[2],
          commercialPrice: parseFloat(values[3]),
          p2pRate: parseFloat(values[4]),
          spread: parseFloat(values[5]),
          profitable: values[6] === 'true'
        };
      });
    }

    function updateDashboard(entries) {
      // Stats
      document.getElementById('total-entries').textContent = entries.length;

      if (entries.length > 0) {
        const avgSpread = entries.reduce((sum, e) => sum + e.spread, 0) / entries.length;
        document.getElementById('avg-spread').textContent = `$${avgSpread.toFixed(2)}`;

        const highPriority = entries.filter(e => e.spread > 120).length;
        document.getElementById('high-priority').textContent = highPriority;
      }

      // Table
      const tbody = document.getElementById('entries-table');
      tbody.innerHTML = entries.slice(-10).reverse().map(e => `
        <tr class="${e.spread > 120 ? 'bg-green-50' : ''}">
          <td class="px-4 py-3 text-sm">${new Date(e.timestamp).toLocaleDateString()}</td>
          <td class="px-4 py-3 text-sm font-medium">${e.facility}</td>
          <td class="px-4 py-3 text-sm">${e.zip}</td>
          <td class="px-4 py-3 text-sm">$${e.commercialPrice.toFixed(2)}</td>
          <td class="px-4 py-3 text-sm">$${e.p2pRate.toFixed(2)}</td>
          <td class="px-4 py-3 text-sm font-bold ${e.spread > 0 ? 'text-green-600' : 'text-red-600'}">
            $${e.spread.toFixed(2)}
            ${e.spread > 120 ? '<span class="ml-2 px-2 py-1 text-xs bg-green-500 text-white rounded">HIGH</span>' : ''}
          </td>
        </tr>
      `).join('');

      // Chart
      const ctx = document.getElementById('spreadChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: entries.map(e => e.facility.substring(0, 20)),
          datasets: [{
            label: 'Monthly Spread ($)',
            data: entries.map(e => e.spread),
            backgroundColor: entries.map(e =>
              e.spread > 120 ? 'rgba(34, 197, 94, 0.8)' :
              e.spread > 0 ? 'rgba(59, 130, 246, 0.8)' :
              'rgba(239, 68, 68, 0.8)'
            ),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => '$' + value
              }
            }
          }
        }
      });
    }

    // Initialize
    fetchData().then(updateDashboard);
  </script>
</body>
</html>
